<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>THE BEST - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; font-family:'Cairo',sans-serif; }
    body {
      margin:0;height:100vh;display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle at top left,#141E30,#243B55);
      color:white; overflow:hidden;
    }
    .login-box {
      background:rgba(0,0,0,0.6);padding:40px;border-radius:20px;
      width:90%;max-width:400px;text-align:center;
      box-shadow:0 0 20px rgba(0,255,255,0.2);
    }
    .login-box input {
      width:100%;padding:14px;border-radius:12px;margin-bottom:15px;
      background:#111;color:#fff;font-size:18px;border:none;outline:none;
      text-align:center;box-shadow:0 0 10px rgba(0,255,255,0.3);
    }
    button {
      width:100%;padding:12px;font-size:18px;border:none;
      border-radius:8px;background:linear-gradient(90deg,#00c6ff,#0072ff);
      color:white;cursor:pointer;transition:.3s;
    }
    button:hover { transform:scale(1.05); }
    .error { color:#ff4f4f; }
    .success { color:#00f5c4; }
    #contactDev {
      margin-top:15px;display:none;padding:10px;border-radius:10px;
      background:linear-gradient(90deg,#25d366,#128c7e);
      color:white;text-decoration:none;font-size:16px;
      display:flex;align-items:center;gap:8px;justify-content:center;
    }
  </style>
</head>

<body>
  <div class="login-box">
    <h1>THE BEST</h1>
    <h2>Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

    <input type="text" id="codeInput" placeholder="CODE">
    <button onclick="verifyCode()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

    <p id="status"></p>

    <a id="contactDev" href="https://wa.me/201001257486" target="_blank">
      <img src="https://img.icons8.com/color/48/000000/whatsapp--v1.png" width="20">
      ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±
    </a>
  </div>

<script>
const firebaseConfig = {
  databaseURL: "https://website-83e14-default-rtdb.firebaseio.com/"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ğŸ”¥ Ø¥Ù†Ø´Ø§Ø¡ deviceId Ø«Ø§Ø¨Øª
const deviceId = localStorage.getItem("deviceId") || generateDeviceId();
localStorage.setItem("deviceId", deviceId);

function generateDeviceId() {
  return "DEV-" + Math.random().toString(36).substring(2, 12);
}

// ======================
//  Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
// ======================
function verifyCode() {
  const code = document.getElementById("codeInput").value.trim();
  const status = document.getElementById("status");
  const btn = document.getElementById("contactDev");

  status.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...";
  status.className = "";
  btn.style.display = "none";

  if (code === "") {
    status.textContent = "âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹";
    status.className = "error";
    return;
  }

  db.ref("codes").orderByChild("code").equalTo(code).once("value", (snapshot) => {
    if (!snapshot.exists()) {
      status.textContent = "âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­.";
      status.className = "error";
      btn.style.display = "flex";
      return;
    }

    const key = Object.keys(snapshot.val())[0];
    const data = snapshot.val()[key];

    const now = Date.now();

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ù‚Ø¨Ù„ â‡¦ Ø£Ù†Ø´Ø¦ Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ©
    if (!data.deviceId) {
      let expireTime;

      if (data.type === "trial") {
        expireTime = now + data.minutes * 60000;
      }
      else if (data.type === "sub") {
        expireTime = now + data.days * 24 * 60 * 60 * 1000;
      }
      else {
        status.textContent = "âš  ÙƒÙˆØ¯ ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·.";
        status.className = "error";
        return;
      }

      db.ref("codes/" + key).update({
        deviceId: deviceId,
        expire: expireTime
      });

      status.textContent = "âœ… ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©!";
      status.className = "success";
      // window.location.href = "student.html";
      return;
    }

    // ØªØ­Ù‚Ù‚ Ø§Ù„Ø¬Ù‡Ø§Ø²
    if (data.deviceId !== deviceId) {
      status.textContent = "âš  Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙØ¹Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.";
      status.className = "error";
      return;
    }

    // ØªØ­Ù‚Ù‚ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    if (data.expire <= now) {
      status.textContent = "â›” Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯.";
      status.className = "error";
      return;
    }

    // Ù†Ø¬Ø§Ø­
    status.textContent = "âœ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­!";
    status.className = "success";
    // window.location.href = "student.html";
  });
}
</script>

</body>
</html>
