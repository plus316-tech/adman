<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Dashboard â€” Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f0f12;--card:#141418;--accent:#4e00ff;--danger:#ff3b3b;--ok:#00e1a6}
  *{box-sizing:border-box;font-family:'Cairo',sans-serif}
  body{margin:0;background:linear-gradient(180deg,#07070a,var(--bg));color:#fff;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .small{opacity:0.8;font-size:13px}
  .wrap{max-width:1100px;margin:18px auto}
  .card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:14px;border:1px solid rgba(255,255,255,0.03)}
  label{display:block;margin-top:8px;margin-bottom:6px;font-weight:600}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:rgba(255,255,255,0.02);color:#fff}
  button{background:var(--accent);border:none;color:#001;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .row-2{grid-template-columns:repeat(2,1fr)}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:center}
  th{background:rgba(255,255,255,0.02);font-weight:700}
  .btn-sm{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
  .btn-del{background:var(--danger);color:#fff}
  .btn-copy{background:#1f8bff;color:#fff}
  .btn-block{background:#ff8b00;color:#fff}
  .btn-unblock{background:#00b894;color:#fff}
  .hidden{display:none}
  .stats{display:flex;gap:10px}
  .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;text-align:center;min-width:120px}
  .right{display:flex;gap:8px;align-items:center}
  @media(max-width:900px){.row{grid-template-columns:1fr}.stats{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap">

    <!-- ğŸ” Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† -->
    <div id="adminLoginCard" class="card" style="margin-bottom:16px;">
      <h3>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>

      <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
      <input id="adminEmail" type="email" placeholder="admin@example.com">

      <label>Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</label>
      <input id="adminPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">

      <button id="adminLoginBtn" style="margin-top:12px;background:#00e1a6;color:#000;font-weight:700">
        ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø£Ø¯Ù…Ù†
      </button>
    </div>

    <header>
      <div>
        <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h1>
        <div class="small">ØªÙˆÙ„ÙŠØ¯ØŒ Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø­Ø¸Ø± Ø£Ø¬Ù‡Ø²Ø©ØŒ Ø±ÙØ¹ Ø­Ø¸Ø±ØŒ ØªØµØ¯ÙŠØ±</div>
      </div>
      <div class="right">
        <div id="adminUidDisplay" class="small">Ø¬Ø§Ø±Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...</div>
        <button id="logoutBtn" class="hidden">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ© -->
    <div id="forbidden" class="card hidden" style="color:var(--danger);text-align:center;font-weight:700">
      âŒ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” uid Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ø£Ø¯Ù…Ù†
    </div>

    <!-- admin area -->
    <div id="adminArea" class="hidden">
      <div class="card">
        <div class="stats">
          <div class="stat"><div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</div><div id="statTotal">-</div></div>
          <div class="stat"><div class="small">Ø£ÙƒÙˆØ§Ø¯ ÙØ¹Ø§Ù„Ø©</div><div id="statActive">-</div></div>
          <div class="stat"><div class="small">Ø£ÙƒÙˆØ§Ø¯ Ù…Ù†ØªÙ‡ÙŠØ©</div><div id="statExpired">-</div></div>
          <div class="stat"><div class="small">Ø£Ø¬Ù‡Ø²Ø© Ù…Ø­Ø¸ÙˆØ±Ø©</div><div id="statBlocked">-</div></div>
        </div>
      </div>

      <!-- ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ -->
      <div class="card">
        <h3>âš¡ ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯</h3>
        <div class="row">
          <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</label><input id="autoCount" type="number" placeholder="Ù…Ø«Ø§Ù„: 20"></div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¯Ø©</label>
            <select id="autoDurationType">
              <option value="minutes">Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="hours">Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª</option>
              <option value="days">Ø¨Ø§Ù„Ø§Ù„Ø£ÙŠØ§Ù…</option>
            </select>
          </div>
          <div><label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø©</label><input id="autoDurationValue" type="number" placeholder="Ù…Ø«Ø§Ù„: 60"></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="genBtn">âš¡ ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
          <button id="genSingleBtn" style="background:#00b894">â• ØªÙˆÙ„ÙŠØ¯ ÙˆØ§Ø­Ø¯</button>
          <button id="exportBtn" style="background:#1f8bff">â¬‡ ØªØµØ¯ÙŠØ± CSV</button>
        </div>
      </div>

      <!-- Ø£ÙƒÙˆØ§Ø¯ -->
      <div class="card">
        <h3>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h3>
        <div style="margin-bottom:8px">
          <label>Ø¨Ø­Ø« (ÙƒÙˆØ¯ Ø£Ùˆ Ø­Ø§Ù„Ø©)</label>
          <input id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
        </div>

        <table>
          <thead>
            <tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¬Ù‡Ø§Ø²</th><th>Ø¥Ù†Ø´Ø§Ø¡</th><th>Ù†Ø³Ø®</th><th>Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø²</th><th>Ø­Ø°Ù</th></tr>
          </thead>
          <tbody id="codesTable"></tbody>
        </table>
      </div>

      <!-- blocked devices -->
      <div class="card">
        <h3>ğŸš« Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</h3>
        <table>
          <thead><tr><th>Device ID</th><th>ØªÙ‚Ø±ÙŠØ± Ù…Ù†</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¸Ø±</th><th>Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±</th></tr></thead>
          <tbody id="blockedTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
  /******* CONFIG *******/

  const firebaseConfig = {
    apiKey: "YOUR-API-KEY",
    authDomain: "YOUR-PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR-PROJECT-default-rtdb.firebaseio.com",
    projectId: "YOUR-PROJECT-ID",
    storageBucket: "YOUR-PROJECT.appspot.com",
    messagingSenderId: "ID",
    appId: "APP-ID"
  };

  // âš  Ø¶Ø¹ Ù‡Ù†Ø§ UID Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
  const ADMIN_UID = "Ø¶Ø¹-Ù‡Ù†Ø§-UID-Ø§Ù„Ø§Ø¯Ù…Ù†";

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  const adminArea = document.getElementById('adminArea');
  const forbidden = document.getElementById('forbidden');
  const adminUidDisplay = document.getElementById('adminUidDisplay');
  const logoutBtn = document.getElementById('logoutBtn');
  const adminLoginCard = document.getElementById("adminLoginCard");

  /********** ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† **********/
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  adminLoginBtn.addEventListener('click', async () => {
    const email = document.getElementById('adminEmail').value.trim();
    const pass  = document.getElementById('adminPass').value.trim();
    if (!email || !pass) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯");

    try {
      const cred = await auth.signInWithEmailAndPassword(email, pass);

      if (cred.user.uid !== ADMIN_UID) {
        alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© â€” UID ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø£Ø¯Ù…Ù†");
        await auth.signOut();
        return;
      }

      alert("âœ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ù†Ø§Ø¬Ø­");
      adminLoginCard.classList.add("hidden");

    } catch(err){
      alert("âŒ Ø®Ø·Ø£: " + err.message);
    }
  });

  /********** Auth State **********/
  auth.onAuthStateChanged(user => {
    if (!user) {
      adminUidDisplay.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      forbidden.classList.add('hidden');
      adminArea.classList.add('hidden');
      adminLoginCard.classList.remove("hidden");
      return;
    }

    adminUidDisplay.textContent = "uid: " + user.uid;
    logoutBtn.classList.remove("hidden");
    logoutBtn.onclick = () => auth.signOut().then(() => location.reload());

    if (user.uid === ADMIN_UID) {
      adminArea.classList.remove('hidden');
      forbidden.classList.add('hidden');
      adminLoginCard.classList.add("hidden");
      loadCodesRealtime();
      loadBlockedRealtime();
    } else {
      adminArea.classList.add('hidden');
      forbidden.classList.remove('hidden');
      adminLoginCard.classList.remove("hidden");
    }
  });

  /********** Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø§Ù„Ø¶Ø¨Ø·  â€” Ù„Ø§ ØªØºÙŠÙŠØ± Ø¥Ø·Ù„Ø§Ù‚Ù‹Ø§ **********/
  function generateCode(){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let c="";
    for(let i=0;i<6;i++) c+=chars[Math.floor(Math.random()*chars.length)];
    return c;
  }

  // ØªÙˆÙ„ÙŠØ¯ Ùˆ Ø¥Ø¯Ø§Ø±Ø© Ùˆ Ø¹Ø±Ø¶ Ùˆ CSV Ùˆ Ø§Ù„Ø­Ø¸Ø± ... (ÙƒÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ)
  // -----------------------------------------------------------
  // Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ 100% Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„
  // -----------------------------------------------------------

  const statTotal=document.getElementById('statTotal');
  const statActive=document.getElementById('statActive');
  const statExpired=document.getElementById('statExpired');
  const statBlocked=document.getElementById('statBlocked');

  const genBtn=document.getElementById('genBtn');
  const genSingleBtn=document.getElementById('genSingleBtn');
  const exportBtn=document.getElementById('exportBtn');
  const codesTable=document.getElementById('codesTable');
  const blockedTable=document.getElementById('blockedTable');
  const searchInput=document.getElementById('searchInput');

  genBtn.addEventListener('click',()=>generateAutoCodes());
  genSingleBtn.addEventListener('click',()=>generateSingleCode());

  function generateSingleCode(){
    if(!isAdmin())return alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const type=document.getElementById('autoDurationType').value;
    const val=parseInt(document.getElementById('autoDurationValue').value);
    if(!val)return alert("Ø§ÙƒØªØ¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø©");
    const code=generateCode();
    const expiresAt=calcExpiry(type,val);
    db.ref('approvedCodes/'+code).set({
      expiresAt,createdAt:Date.now(),active:true,usedBy:'',deviceId:''
    }).then(()=>alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯: "+code));
  }

  function generateAutoCodes(){
    if(!isAdmin())return alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const count=parseInt(document.getElementById('autoCount').value);
    const type=document.getElementById('autoDurationType').value;
    const val=parseInt(document.getElementById('autoDurationValue').value);
    if(!count)return alert("Ø§ÙƒØªØ¨ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­");
    if(!val)return alert("Ø§ÙƒØªØ¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø©");
    const updates={};
    for(let i=0;i<count;i++){
      const code=generateCode();
      updates['approvedCodes/'+code]={
        expiresAt:calcExpiry(type,val),
        createdAt:Date.now(),
        active:true,
        usedBy:'',
        deviceId:''
      };
    }
    db.ref().update(updates).then(()=>alert("âœ” ØªÙ… ØªÙˆÙ„ÙŠØ¯ "+count+" ÙƒÙˆØ¯"));
  }

  function calcExpiry(type,val){
    const now=Date.now();
    if(type==='minutes')return now+val*60*1000;
    if(type==='hours')return now+val*60*60*1000;
    if(type==='days')return now+val*24*60*60*1000;
    return now;
  }

  function isAdmin(){
    const u=auth.currentUser;
    return u && u.uid===ADMIN_UID;
  }

  let latestCodes={};
  function loadCodesRealtime(){
    const ref=db.ref('approvedCodes');
    ref.on('value',snap=>{
      const data=snap.val()||{};
      latestCodes=data;
      renderCodesTable(data);
      updateStats();
    });
  }

  function renderCodesTable(data){
    const q=(searchInput.value||'').trim().toLowerCase();
    codesTable.innerHTML="";
    const rows=Object.keys(data).sort();
    rows.forEach(code=>{
      const d=data[code];
      const exp=d.expiresAt||0;
      const active=d.active&&(exp>Date.now());
      const state=active?"Ù†Ø´Ø·":"Ù…Ù†ØªÙ‡ÙŠ";
      const created=d.createdAt?new Date(d.createdAt).toLocaleString():"-";
      const deviceId=d.deviceId||'-';

      if(q && !code.toLowerCase().includes(q)
           && !state.includes(q)
           && !deviceId.toLowerCase().includes(q)) return;

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${code}</td>
        <td>${new Date(exp).toLocaleString()}</td>
        <td>${state}</td>
        <td>${deviceId}</td>
        <td>${created}</td>
        <td><button class="btn-sm btn-copy" data-code="${code}">Ù†Ø³Ø®</button></td>
        <td><button class="btn-sm btn-block" data-device="${deviceId}" data-code="${code}">
          Ø­Ø¸Ø±
        </button></td>
        <td><button class="btn-sm btn-del" data-code="${code}">Ø­Ø°Ù</button></td>
      `;
      codesTable.appendChild(tr);
    });

    document.querySelectorAll('.btn-copy').forEach(btn=>{
      btn.onclick=e=>{
        const c=e.target.dataset.code;
        navigator.clipboard.writeText(c);
        alert("ØªÙ… Ù†Ø³Ø®: "+c);
      };
    });

    document.querySelectorAll('.btn-del').forEach(btn=>{
      btn.onclick=e=>{
        const c=e.target.dataset.code;
        if(confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ "+c+" ØŸ"))
          db.ref('approvedCodes/'+c).remove();
      };
    });
  }

  searchInput.addEventListener('input',()=>renderCodesTable(latestCodes));

  function updateStats(){
    const now=Date.now();
    const keys=Object.keys(latestCodes);
    let a=0,b=0;
    keys.forEach(k=>{
      const e=latestCodes[k].expiresAt||0;
      if(e>now && latestCodes[k].active)a++;
      else b++;
    });
    statTotal.textContent=keys.length;
    statActive.textContent=a;
    statExpired.textContent=b;
  }

  function blockDevice(id){
    if(!isAdmin())return alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    if(!id)return alert("Device ID ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    db.ref('blockedDevices/'+id).set({
      uid:auth.currentUser.uid,
      blockedAt:Date.now(),
      reason:"admin"
    }).then(()=>alert("ØªÙ… Ø§Ù„Ø­Ø¸Ø±"));
  }

  function loadBlockedRealtime(){
    const ref=db.ref('blockedDevices');
    ref.on('value',snap=>{
      const data=snap.val()||{};
      renderBlockedTable(data);
      statBlocked.textContent=Object.keys(data).length;
    });
  }

  function renderBlockedTable(data){
    blockedTable.innerHTML="";
    const keys=Object.keys(data);
    if(!keys.length){
      blockedTable.innerHTML='<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¸Ø±</td></tr>';
      return;
    }
    keys.forEach(id=>{
      const d=data[id];
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${id}</td>
        <td>${d.uid}</td>
        <td>${new Date(d.blockedAt).toLocaleString()}</td>
        <td><button class="btn-sm btn-unblock" data-id="${id}">Ø±ÙØ¹</button></td>
      `;
      blockedTable.appendChild(tr);
    });

    document.querySelectorAll('.btn-unblock').forEach(btn=>{
      btn.onclick=e=>{
        const id=e.target.dataset.id;
        if(confirm("Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±ØŸ")) db.ref('blockedDevices/'+id).remove();
      };
    });
  }

  </script>
</body>
</html>
