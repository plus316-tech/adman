<!doctype html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة تحكم - إدارة أكواد التفعيل (منصة 1383)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root{ --bg:#071226; --card:#0f1530; --accent1:#a333ff; --accent2:#00f5ff; --muted:rgba(255,255,255,0.6) }
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    body{min-height:100vh;margin:0;padding:28px;background:linear-gradient(180deg,#030416, #071226);color:#fff}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;gap:18px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:1.2rem}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:12px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:14px}label{display:block;font-size:0.85rem;margin-bottom:6px;color:var(--muted)}
input,select,button{font-family:'Cairo',sans-serif}
.form-row{margin-bottom:10px}
.input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff}
.small{font-size:0.85rem}
.btn{display:inline-block;padding:10px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041426;cursor:pointer;font-weight:700}
.btn:disabled{opacity:0.6;cursor:not-allowed}

/* table */
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:right;font-size:0.95rem}
th{color:var(--muted);font-weight:700}
.muted{color:var(--muted);font-size:0.85rem}
.actions button{margin-left:6px}

.status{margin-top:8px;padding:8px;border-radius:8px}
.success{background:rgba(0,245,196,0.06);border:1px solid rgba(0,245,196,0.12);color:#00f5c4}
.error{background:rgba(255,79,79,0.06);border:1px solid rgba(255,79,79,0.12);color:#ff6b6b}
.pending{background:rgba(255,179,71,0.06);border:1px solid rgba(255,179,71,0.12);color:#ffb347}

/* responsive */
@media (max-width:980px){.grid{grid-template-columns:1fr} .wrap{padding:8px}}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>لوحة تحكم -- إدارة أكواد التفعيل (6 أرقام)</h1>
      <div class="muted">مبني لهيكلتك: <code>approvedStudents/{code}</code></div>
    </header><div class="grid">
  <!-- يمين: لوحة توليد الأكواد -->
  <div class="card">
    <h3>توليد أكواد جديدة</h3>
    <div class="form-row">
      <label>نوع الكود</label>
      <select id="codeType" class="input small">
        <option value="trial">تجربة (بالدقايق)</option>
        <option value="subscription">اشتراك (بالأيام)</option>
      </select>
    </div>

    <div class="form-row" id="durationRow">
      <label id="durationLabel">المدة (دقايق للتجربة / أيام للاشتراك)</label>
      <input id="durationInput" class="input" type="number" min="1" value="30">
    </div>

    <div class="form-row">
      <label>عدد الأكواد</label>
      <input id="countInput" class="input" type="number" min="1" max="500" value="10">
    </div>

    <div class="form-row">
      <label>بادئة اختيارية (مثال: 9 أو اتركها فارغة)</label>
      <input id="prefixInput" class="input" type="text" maxlength="2" placeholder="مثال: 9">
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="generateBtn" class="btn">توليد أكواد</button>
      <button id="downloadBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">تنزيل CSV</button>
    </div>

    <div id="genStatus" class="status muted" style="display:none"></div>

    <div style="margin-top:12px">
      <label class="muted">الأكواد المتولدة حديثًا</label>
      <textarea id="generatedList" rows="6" style="width:100%;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:#fff"></textarea>
    </div>
  </div>

  <!-- يسار: قائمة الأكواد الموجودة -->
  <div class="card">
    <h3>قائمة الأكواد</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="searchInput" class="input" placeholder="ابحث برقم الكود أو الحالة" />
      <button id="refreshBtn" class="btn">تحديث</button>
    </div>

    <div id="tableWrap" style="max-height:520px;overflow:auto">
      <table id="codesTable">
        <thead>
          <tr><th>الكود</th><th>النوع</th><th>الصلاحية</th><th>جهاز</th><th>الحالة</th><th>تحكم</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="listStatus" class="status muted" style="display:none"></div>
  </div>
</div>

<div style="height:12px"></div>
<div class="muted">ملاحظة: التطبيق يستخدم المسار <code>approvedStudents/{code}</code>. الحقول التي نضعها لكل كود:
  <ul>
    <li><code>expiry</code> -- timestamp (Number)</li>
    <li><code>isBlocked</code> -- Boolean</li>
    <li><code>deviceId</code> -- String أو غير موجود</li>
    <li><code>type</code> -- "trial" أو "subscription"</li>
    <li><code>duration</code> -- القيمة بالأرقام (دقايق إن كان trial، أيام إن كان subscription)</li>
    <li><code>createdAt</code> -- timestamp</li>
  </ul>
</div>

  </div>  <!-- Firebase compat -->  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>  <script>
    // --- ضع إعدادات Firebase الخاصة بك هنا (أو اتركها كما لديك في صفحة التفعيل) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAdz_OsGPL5xEq-J72FCkuQezVMhU_FATo",
      authDomain: "website-83e14.firebaseapp.com",
      databaseURL: "https://website-83e14-default-rtdb.firebaseio.com",
      projectId: "website-83e14",
      storageBucket: "website-83e14.firebasestorage.app",
      messagingSenderId: "994953388464",
      appId: "1:994953388464:web:9c244de2a4fdcf8561f675",
      measurementId: "G-7PN256M5PG"
    };

    if (typeof firebase === 'undefined' || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // عناصر DOM
    const codeType = document.getElementById('codeType');
    const durationInput = document.getElementById('durationInput');
    const durationLabel = document.getElementById('durationLabel');
    const countInput = document.getElementById('countInput');
    const prefixInput = document.getElementById('prefixInput');
    const generateBtn = document.getElementById('generateBtn');
    const generatedList = document.getElementById('generatedList');
    const genStatus = document.getElementById('genStatus');
    const downloadBtn = document.getElementById('downloadBtn');

    const refreshBtn = document.getElementById('refreshBtn');
    const tableBody = document.querySelector('#codesTable tbody');
    const listStatus = document.getElementById('listStatus');
    const searchInput = document.getElementById('searchInput');

    // تكوين
    const DIGITS = 6; // 6 أرقام كما طلبت

    codeType.addEventListener('change', () => {
      if (codeType.value === 'trial') {
        durationLabel.textContent = 'المدة (دقايق للتجربة)';
        durationInput.value = 30;
      } else {
        durationLabel.textContent = 'المدة (أيام للاشتراك)';
        durationInput.value = 30;
      }
    });

    // مولد كود رقمى مكون من 6 أرقام. يمكن إضافة بادئة قصيرة.
    function generateNumericCode(prefix = ''){
      // نتأكد أن الناتج طول DIGITS
      const max = Math.pow(10, DIGITS) - 1;
      const min = Math.pow(10, DIGITS - 1);
      const num = Math.floor(Math.random() * (max - min + 1)) + min;
      return prefix + String(num);
    }

    // تحقق من التكرار في قاعدة البيانات
    async function isCodeExists(code){
      const snap = await db.ref('approvedStudents/' + code).once('value');
      return snap.exists();
    }

    // توليد دفعة من الأكواد
    async function generateBatch(){
      const type = codeType.value;
      const duration = Number(durationInput.value) || 1;
      const count = Math.min(500, Math.max(1, Number(countInput.value) || 1));
      const prefix = (prefixInput.value || '').toString();

      generatedList.value = '';
      genStatus.style.display = 'block';
      genStatus.className = 'status pending';
      genStatus.textContent = '⏳ جاري توليد الأكواد... (التحقق من التكرار في قاعدة البيانات)';
      generateBtn.disabled = true;

      const created = [];
      const errors = [];

      for (let i = 0; i < count; i++){
        let attempts = 0;
        let code = '';
        while (attempts < 8){ // محاولات قليلة للتفادى
          code = generateNumericCode(prefix);
          if (!(await isCodeExists(code))) break;
          attempts++;
        }
        if (attempts >= 8){ errors.push(code); continue; }

        const now = Date.now();
        let expiry = now;
        if (type === 'trial'){
          expiry = now + (duration * 60 * 1000); // دقائق -> ms
        } else {
          expiry = now + (duration * 24 * 60 * 60 * 1000); // أيام -> ms
        }

        const payload = {
          expiry: expiry,
          isBlocked: false,
          deviceId: null,
          type: type,
          duration: duration,
          createdAt: now
        };

        try {
          await db.ref('approvedStudents/' + code).set(payload);
          created.push({code, ...payload});
          generatedList.value += code + '\n';
        } catch (err){
          console.error('create error', err);
          errors.push(code);
        }
      }

      genStatus.className = 'status success';
      genStatus.textContent = ✅ تم توليد ${created.length} كود. فشل: ${errors.length};
      generateBtn.disabled = false;
      // حفظ نتائج للتحميل
      generateBtn.dataset.last = JSON.stringify(created);
      refreshTable();
    }

    generateBtn.addEventListener('click', generateBatch);

    // تحميل CSV
    downloadBtn.addEventListener('click', () => {
      const data = generateBtn.dataset.last;
      if (!data) return alert('لا توجد أكواد متولدة حديثًا');
      const arr = JSON.parse(data);
      const header = ['code','type','duration','expiry','deviceId','isBlocked','createdAt'];
      const rows = arr.map(r => [r.code,r.type,r.duration,r.expiry,r.deviceId || '',r.isBlocked,r.createdAt]);
      const csv = [header.join(','), ...rows.map(r=>r.map(x=>"${x}").join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'codes.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // تحميل وعرض قائمة الأكواد (محددة بعدد لعرض أولي)
    async function refreshTable(){
      tableBody.innerHTML = '';
      listStatus.style.display = 'block';
      listStatus.className = 'status pending';
      listStatus.textContent = '⏳ جاري جلب أكواد من قاعدة البيانات...';

      try{
        const snap = await db.ref('approvedStudents').orderByKey().limitToLast(500).once('value');
        const data = snap.val() || {};
        const arr = Object.keys(data).reverse().map(k => ({code:k, ...data[k]}));

        // فلترة بحث
        const q = (searchInput.value || '').trim();
        const filtered = arr.filter(item => {
          if (!q) return true;
          return item.code.includes(q) || (item.type && item.type.includes(q)) || (String(item.isBlocked) === q);
        });

        if (!filtered.length){
          listStatus.className = 'status error';
          listStatus.textContent = 'لا توجد أكواد للعرض.';
          return;
        }

        listStatus.style.display = 'none';

        for (const it of filtered){
          const tr = document.createElement('tr');

          const expiryText = it.expiry ? (new Date(it.expiry)).toLocaleString('ar-EG') : '--';
          const state = it.isBlocked ? 'محظور' : (it.expiry && it.expiry <= Date.now() ? 'منتهي' : 'ساري');

          tr.innerHTML = `
            <td><strong>${it.code}</strong></td>
            <td>${it.type || '-'}</td>
            <td class="small">${expiryText}<div class="muted">(${it.duration} ${it.type==='trial'?'دقايق':'أيام'})</div></td>
            <td class="small">${it.deviceId || '-'}</td>
            <td>${state}</td>
            <td class="actions small">
              <button data-code="${it.code}" class="btn unblockBtn">إعادة ضبط الجهاز</button>
              <button data-code="${it.code}" class="btn blockBtn">حظر</button>
              <button data-code="${it.code}" class="btn extendBtn">تمديد</button>
              <button data-code="${it.code}" class="btn deleteBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">حذف</button>
            </td>
          `;

          tableBody.appendChild(tr);
        }

        // ربط الأحداث للأزرار
        document.querySelectorAll('.unblockBtn').forEach(b=>b.addEventListener('click', resetDevice));
        document.querySelectorAll('.blockBtn').forEach(b=>b.addEventListener('click', blockCode));
        document.querySelectorAll('.extendBtn').forEach(b=>b.addEventListener('click', extendCode));
        document.querySelectorAll('.deleteBtn').forEach(b=>b.addEventListener('click', deleteCode));

      } catch(err){
        console.error('refresh error', err);
        listStatus.className = 'status error';
        listStatus.textContent = '❌ فشل جلب البيانات من الخادم.';
      }
    }

    refreshBtn.addEventListener('click', refreshTable);
    searchInput.addEventListener('input', () => { setTimeout(refreshTable, 400); });

    // إعادة ضبط الجهاز: مسح deviceId
    async function resetDevice(e){
      const code = e.currentTarget.dataset.code;
      if (!confirm('هل تريد مسح الجهاز المرتبط بهذا الكود؟')) return;
      try{
        await db.ref('approvedStudents/' + code + '/deviceId').remove();
        alert('✅ تم مسح deviceId');
        refreshTable();
      }catch(err){console.error(err);alert('فشل العملية')}
    }

    // حظر كود
    async function blockCode(e){
      const code = e.currentTarget.dataset.code;
      if (!confirm('هل تريد حظر هذا الكود؟')) return;
      try{
        await db.ref('approvedStudents/' + code + '/isBlocked').set(true);
        alert('✅ تم حظر الكود');
        refreshTable();
      }catch(err){console.error(err);alert('فشل العملية')}
    }

    // تمديد الصلاحية (يطلب قيمة)
    async function extendCode(e){
      const code = e.currentTarget.dataset.code;
      const add = prompt('أدخل رقم المدة الإضافية (بالدقايق لو trial أو بالأيام لو subscription):');
      if (!add) return;
      const snap = await db.ref('approvedStudents/' + code).once('value');
      const data = snap.val();
      if (!data) return alert('الكود غير موجود');
      const now = Date.now();
      let newExpiry = data.expiry || now;
      if (data.type === 'trial'){
        newExpiry = Math.max(newExpiry, now) + (Number(add) * 60 * 1000);
      } else {
        newExpiry = Math.max(newExpiry, now) + (Number(add) * 24 * 60 * 60 * 1000);
      }
      await db.ref('approvedStudents/' + code + '/expiry').set(newExpiry);
      alert('✅ تم التمديد');
      refreshTable();
    }

    // حذف كود
    async function deleteCode(e){
      const code = e.currentTarget.dataset.code;
      if (!confirm('هل أنت متأكد من حذف هذا الكود نهائيًا؟')) return;
      try{
        await db.ref('approvedStudents/' + code).remove();
        alert('✅ تم الحذف');
        refreshTable();
      }catch(err){console.error(err);alert('فشل الحذف')}
    }

    // جلب أولي
    refreshTable();
  </script></body>
</html>
