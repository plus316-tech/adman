<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة تحكم — منصة 1383 (Admin)</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- Firebase compat (نفس نسخ الصفحة الأصلية) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg-1: #0f044a; --bg-2: #1a004d; --neon-cyan: #00f5ff; --neon-magenta: #a333ff;
      --neon-green: #00f5c4; --glass: rgba(255,255,255,0.06); --glass-border: rgba(255,255,255,0.08);
      --muted: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif}
    html,body{height:100%}
    body{
      min-height:100vh; background: radial-gradient(1200px 600px at 10% 20%, rgba(163,51,255,0.12), transparent),
        radial-gradient(800px 400px at 90% 80%, rgba(0,245,255,0.08), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:#fff; padding:28px; display:flex; align-items:flex-start; justify-content:center;
    }

    .container{ width:100%; max-width:1100px }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px }
    header h1{ font-size:1.4rem }
    header .actions{ display:flex; gap:8px; align-items:center }

    .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--glass-border);
      border-radius:12px; padding:18px; box-shadow: 0 20px 60px rgba(10,6,30,0.6);
    }

    .controls{ display:flex; gap:8px; margin-bottom:12px; align-items:center }
    .search{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:#fff }
    .btn{ padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; background:linear-gradient(90deg,var(--neon-magenta),var(--neon-cyan)); color:#051226 }
    .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted) }

    table{ width:100%; border-collapse:collapse; margin-top:8px }
    th,td{ padding:10px 8px; text-align:right; border-bottom:1px solid rgba(255,255,255,0.03); font-size:0.95rem }
    th{ color:var(--muted); font-weight:600 }
    td small{ display:block; color:rgba(255,255,255,0.6); font-weight:600 }

    .pill{ display:inline-block; padding:6px 8px; border-radius:8px; font-weight:700; font-size:0.85rem }
    .pill.ok{ background: rgba(0,245,196,0.08); color:var(--neon-green); border:1px solid rgba(0,245,196,0.12) }
    .pill.block{ background: rgba(255,79,79,0.06); color:#ff6b6b; border:1px solid rgba(255,79,79,0.12) }
    .pill.warn{ background: rgba(255,179,71,0.06); color:#ffb347; border:1px solid rgba(255,179,71,0.12) }

    .right-col{ display:flex; gap:8px; align-items:center }

    /* modals */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:40 }
    .modal{ width:100%; max-width:520px; background:#07102a; border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.04) }
    .form-row{ margin-bottom:10px }
    .input{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:#fff }
    label{ display:block; margin-bottom:6px; color:var(--muted) }

    .small{ font-size:0.86rem }
    .muted{ color:var(--muted) }

    footer{ margin-top:12px; color:rgba(255,255,255,0.5); font-size:0.84rem; text-align:center }

    @media (max-width:820px){ .right-col{ flex-wrap:wrap } table th,table td{ font-size:0.82rem } }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>لوحة تحكم — أكواد التفعيل (approvedStudents)</h1>
        <div class="muted small">عرض وإدارة أكواد التفعيل المرتبطة بقاعدة بيانات Firebase</div>
      </div>
      <div class="actions right-col">
        <input id="searchInput" class="search" placeholder="ابحث عن كود أو جهاز..." />
        <button id="addBtn" class="btn">إضافة كود جديد</button>
        <button id="exportBtn" class="btn ghost">تصدير CSV</button>
        <button id="logoutBtn" class="btn ghost">تسجيل خروج</button>
      </div>
    </header>

    <div class="card">
      <div id="statusBar" class="muted small">جاري التحميل...</div>

      <table id="codesTable" aria-live="polite">
        <thead>
          <tr>
            <th>الكود</th>
            <th>الجهاز (deviceId)</th>
            <th>تاريخ الانتهاء</th>
            <th>الحالة</th>
            <th style="width:160px">إجراءات</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- rows injected -->
        </tbody>
      </table>

      <footer>حقوق النشر © منصة الثانويه بلس — لوحة التحكم</footer>
    </div>
  </div>

  <!-- Modals: login & add/edit -->
  <div id="loginModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h3>تسجيل دخول المشرف</h3>
      <p class="muted small">أدخل كلمة مرور المشرف للوصول للوحة التحكم.</p>
      <div class="form-row">
        <label>كلمة المرور</label>
        <input id="adminPass" class="input" type="password" placeholder="كلمة مرور المشرف" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="loginCancel" class="btn ghost">إلغاء</button>
        <button id="loginSubmit" class="btn">تسجيل دخول</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h3 id="editTitle">إضافة / تعديل كود</h3>

      <div class="form-row">
        <label>الكود (6 أرقام)</label>
        <input id="codeInput" class="input" maxlength="6" placeholder="123456" />
      </div>

      <div class="form-row">
        <label>deviceId (اختياري)</label>
        <input id="deviceInput" class="input" placeholder="DID-..." />
      </div>

      <div class="form-row">
        <label>تاريخ الانتهاء (تاريخ/وقت)</label>
        <input id="expiryInput" class="input" type="datetime-local" />
      </div>

      <div class="form-row">
        <label><input id="blockedInput" type="checkbox" /> &nbsp;حظر الكود (isBlocked)</label>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="editCancel" class="btn ghost">إلغاء</button>
        <button id="saveBtn" class="btn">حفظ</button>
      </div>
    </div>
  </div>

  <script>
    /*************** إعداد Firebase - غيّر الإعدادات إن لزم ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyAdz_OsGPL5xEq-J72FCkuQezVMhU_FATo",
      authDomain: "website-83e14.firebaseapp.com",
      databaseURL: "https://website-83e14-default-rtdb.firebaseio.com",
      projectId: "website-83e14",
      storageBucket: "website-83e14.firebasestorage.app",
      messagingSenderId: "994953388464",
      appId: "1:994953388464:web:9c244de2a4fdcf8561f675",
      measurementId: "G-7PN256M5PG"
    };

    if (typeof firebase === 'undefined' || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    /*************** مصادقة المشرف (محلي) ***************/
    // غيّر كلمة المرور قبل النشر
    const ADMIN_PASSWORD = 'admin123'; // <- غيّرها

    const loginModal = document.getElementById('loginModal');
    const loginSubmit = document.getElementById('loginSubmit');
    const loginCancel = document.getElementById('loginCancel');
    const adminPass = document.getElementById('adminPass');

    const container = document.querySelector('.container');
    const statusBar = document.getElementById('statusBar');
    const tableBody = document.getElementById('tableBody');
    const searchInput = document.getElementById('searchInput');
    const addBtn = document.getElementById('addBtn');
    const exportBtn = document.getElementById('exportBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const editModal = document.getElementById('editModal');
    const editTitle = document.getElementById('editTitle');
    const codeInput = document.getElementById('codeInput');
    const deviceInput = document.getElementById('deviceInput');
    const expiryInput = document.getElementById('expiryInput');
    const blockedInput = document.getElementById('blockedInput');
    const saveBtn = document.getElementById('saveBtn');
    const editCancel = document.getElementById('editCancel');

    let currentEditKey = null; // code being edited
    let snapshotCache = {};

    /*************** آلية دخول المشرف (محلي) ***************/
    function showLogin(){ loginModal.style.display = 'flex'; adminPass.value = ''; adminPass.focus(); }
    function hideLogin(){ loginModal.style.display = 'none'; }

    loginCancel.addEventListener('click', () => { hideLogin(); /* منع الوصول */ });

    loginSubmit.addEventListener('click', () => {
      const val = adminPass.value || '';
      if(val === ADMIN_PASSWORD){
        localStorage.setItem('admin_logged_1383','1');
        hideLogin();
        initApp();
      } else {
        alert('كلمة مرور خاطئة');
      }
    });

    // تحقق من حالة الجلسة
    if(localStorage.getItem('admin_logged_1383') !== '1'){
      showLogin();
    } else {
      initApp();
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('admin_logged_1383');
      showLogin();
    });

    /*************** تهيئة التطبيق: استمع للـ DB واعرض البيانات ***************/
    function formatDate(ts){ if(!ts) return '-'; const d = new Date(Number(ts)); return d.toLocaleString('ar-EG'); }

    function renderTable(filter=''){
      tableBody.innerHTML = '';
      const keys = Object.keys(snapshotCache).sort();
      if(keys.length === 0){ statusBar.textContent = 'لا توجد سجلات.'; return; }
      let shown = 0;
      for(const code of keys){
        const data = snapshotCache[code] || {};
        const deviceId = data.deviceId || '-';
        const expiry = data.expiry || null;
        const isBlocked = !!data.isBlocked;

        // فلترة
        const hay = (code + ' ' + deviceId).toLowerCase();
        if(filter && !hay.includes(filter.trim().toLowerCase())) continue;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${code}</strong><small>${data.studentName ? data.studentName : ''}</small></td>
          <td style="max-width:260px;word-break:break-all">${deviceId}</td>
          <td>${expiry ? formatDate(expiry) : '-'}${expiry && expiry < Date.now() ? ' <span class="pill warn">منتهي</span>' : ''}</td>
          <td>${isBlocked ? '<span class="pill block">محظور</span>' : '<span class="pill ok">صالح</span>'}</td>
          <td>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn ghost btn-edit" data-code="${code}">تعديل</button>
              <button class="btn ghost btn-delete" data-code="${code}">حذف</button>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);
        shown++;
      }
      statusBar.textContent = `عرض ${shown} من ${Object.keys(snapshotCache).length} كود.`;
    }

    function initApp(){
      statusBar.textContent = 'جاري الاتصال بقاعدة البيانات...';

      const ref = db.ref('approvedStudents');
      // استمع للتغييرات الحيّة
      ref.on('value', (snap) => {
        const val = snap.val() || {};
        snapshotCache = val;
        renderTable(searchInput.value || '');
      }, (err) => {
        console.error('DB listen error', err);
        statusBar.textContent = 'فشل الاتصال بقاعدة البيانات.';
      });

      // event delegation للطاولة
      tableBody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.btn-edit');
        const delBtn = e.target.closest('.btn-delete');
        if(editBtn){ openEdit(editBtn.dataset.code); }
        if(delBtn){ confirmDelete(delBtn.dataset.code); }
      });

      // البحث
      searchInput.addEventListener('input', (ev) => renderTable(ev.target.value));

      // إضافة
      addBtn.addEventListener('click', () => { openEdit(); });

      // حفظ من المودال
      saveBtn.addEventListener('click', async () => {
        const code = (codeInput.value || '').trim();
        if(!/^\d{6}$/.test(code)) return alert('ادخل كود مكون من 6 أرقام');

        const payload = {};
        const device = (deviceInput.value || '').trim();
        if(device) payload.deviceId = device;

        const expVal = expiryInput.value;
        if(expVal){
          // تحويل datetime-local إلى timestamp
          const t = new Date(expVal);
          if(!isNaN(t)) payload.expiry = t.getTime();
        }
        payload.isBlocked = !!blockedInput.checked;

        try{
          // كتابة أو تحديث
          await db.ref('approvedStudents/' + code).update(payload);
          hideEdit();
        } catch(err){ console.error('save error', err); alert('فشل الحفظ'); }
      });

      editCancel.addEventListener('click', hideEdit);

      exportBtn.addEventListener('click', exportCSV);
    }

    function openEdit(code){
      currentEditKey = code || null;
      editTitle.textContent = code ? 'تعديل الكود ' + code : 'إضافة كود جديد';
      codeInput.value = code || '';
      codeInput.disabled = !!code; // لا نسمح بتغيير المفتاح إذا كان موجود
      deviceInput.value = '';
      expiryInput.value = '';
      blockedInput.checked = false;

      if(code && snapshotCache[code]){
        const data = snapshotCache[code];
        deviceInput.value = data.deviceId || '';
        blockedInput.checked = !!data.isBlocked;
        if(data.expiry){
          const d = new Date(Number(data.expiry));
          // تحويل إلى local datetime-local format YYYY-MM-DDThh:mm
          const pad = n => String(n).padStart(2,'0');
          const YYYY = d.getFullYear(); const MM = pad(d.getMonth()+1); const DD = pad(d.getDate());
          const hh = pad(d.getHours()); const mm = pad(d.getMinutes());
          expiryInput.value = `${YYYY}-${MM}-${DD}T${hh}:${mm}`;
        }
      }

      editModal.style.display = 'flex';
    }
    function hideEdit(){ editModal.style.display = 'none'; currentEditKey = null; }

    async function confirmDelete(code){
      if(!confirm('هل تريد حقًا حذف الكود ' + code + '? هذا الإجراء لا يمكن التراجع عنه.')) return;
      try{
        await db.ref('approvedStudents/' + code).remove();
        alert('تم حذف الكود');
      } catch(err){ console.error('delete error', err); alert('فشل الحذف'); }
    }

    function exportCSV(){
      const rows = [['code','deviceId','expiry','isBlocked']];
      for(const k of Object.keys(snapshotCache).sort()){
        const d = snapshotCache[k] || {};
        rows.push([k, d.deviceId || '', d.expiry || '', d.isBlocked ? '1' : '0']);
      }
      const csv = rows.map(r => r.map(cell => '"'+String(cell).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'approvedStudents_export.csv'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

  </script>
</body>
</html>
