<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ù…Ù†ØµØ© 1383)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root{ --bg:#071226; --card:#0f1530; --accent1:#a333ff; --accent2:#00f5ff; --muted:rgba(255,255,255,0.6) }
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    body{min-height:100vh;margin:0;padding:28px;background:linear-gradient(180deg,#030416, #071226);color:#fff}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;gap:18px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:1.2rem}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:12px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:14px}
    label{display:block;font-size:0.85rem;margin-bottom:6px;color:var(--muted)}
    input,select,button{font-family:'Cairo',sans-serif}
    .form-row{margin-bottom:10px}
    .input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff}
    .small{font-size:0.85rem}
    .btn{display:inline-block;padding:10px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041426;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn:disabled{opacity:0.6;cursor:not-allowed}

    /* table */
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:right;font-size:0.95rem}
    th{color:var(--muted);font-weight:700}
    .muted{color:var(--muted);font-size:0.85rem}
    .actions button{margin-left:6px}

    .status{margin-top:8px;padding:8px;border-radius:8px}
    .success{background:rgba(0,245,196,0.06);border:1px solid rgba(0,245,196,0.12);color:#00f5c4}
    .error{background:rgba(255,79,79,0.06);border:1px solid rgba(255,79,79,0.12);color:#ff6b6b}
    .pending{background:rgba(255,179,71,0.06);border:1px solid rgba(255,179,71,0.12);color:#ffb347}

    /* responsive */
    @media (max-width:980px){.grid{grid-template-columns:1fr} .wrap{padding:8px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… -- Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ (6 Ø£Ø±Ù‚Ø§Ù…)</h1>
      <div class="muted">Ù…Ø¨Ù†ÙŠ Ù„Ù‡ÙŠÙƒÙ„ØªÙƒ: <code>approvedStudents/{code}</code></div>
    </header>

    <div class="grid">
      <!-- ÙŠÙ…ÙŠÙ†: Ù„ÙˆØ­Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ -->
      <div class="card">
        <h3>ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <div class="form-row">
          <label>Ù†ÙˆØ¹ Ø§Ù„ÙƒÙˆØ¯</label>
          <select id="codeType" class="input small">
            <option value="trial">ØªØ¬Ø±Ø¨Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§ÙŠÙ‚)</option>
            <option value="subscription">Ø§Ø´ØªØ±Ø§Ùƒ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</option>
          </select>
        </div>

        <div class="form-row" id="durationRow">
          <label id="durationLabel">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§ÙŠÙ‚ Ù„Ù„ØªØ¬Ø±Ø¨Ø© / Ø£ÙŠØ§Ù… Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ)</label>
          <input id="durationInput" class="input" type="number" min="1" value="30">
        </div>

        <div class="form-row">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</label>
          <input id="countInput" class="input" type="number" min="1" max="500" value="10">
        </div>

        <div class="form-row">
          <label>Ø¨Ø§Ø¯Ø¦Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© (Ù…Ø«Ø§Ù„: 9 Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ©ØŒ Ø£Ù‚ØµÙ‰ Ø·ÙˆÙ„ 2)</label>
          <input id="prefixInput" class="input" type="text" maxlength="2" placeholder="Ù…Ø«Ø§Ù„: 9">
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="generateBtn" class="btn">ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯</button>
          <button id="downloadBtn" class="btn ghost">ØªÙ†Ø²ÙŠÙ„ CSV</button>
        </div>

        <div id="genStatus" class="status muted" style="display:none"></div>

        <div style="margin-top:12px">
          <label class="muted">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªÙˆÙ„Ø¯Ø© Ø­Ø¯ÙŠØ«Ù‹Ø§</label>
          <textarea id="generatedList" rows="6" style="width:100%;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:#fff" readonly></textarea>
        </div>
      </div>

      <!-- ÙŠØ³Ø§Ø±: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© -->
      <div class="card">
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="searchInput" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹ Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„Ø©" />
          <button id="refreshBtn" class="btn">ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div id="tableWrap" style="max-height:520px;overflow:auto">
          <table id="codesTable">
            <thead>
              <tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ­ÙƒÙ…</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="listStatus" class="status muted" style="display:none"></div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø± <code>approvedStudents/{code}</code>. Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ Ù†Ø¶Ø¹Ù‡Ø§ Ù„ÙƒÙ„ ÙƒÙˆØ¯:
      <ul>
        <li><code>expiry</code> -- timestamp (Number)</li>
        <li><code>isBlocked</code> -- Boolean</li>
        <li><code>deviceId</code> -- String Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</li>
        <li><code>type</code> -- "trial" Ø£Ùˆ "subscription"</li>
        <li><code>duration</code> -- Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø¯Ù‚Ø§ÙŠÙ‚ Ø¥Ù† ÙƒØ§Ù† trialØŒ Ø£ÙŠØ§Ù… Ø¥Ù† ÙƒØ§Ù† subscription)</li>
        <li><code>createdAt</code> -- timestamp</li>
      </ul>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAdz_OsGPL5xEq-J72FCkuQezVMhU_FATo",
    authDomain: "website-83e14.firebaseapp.com",
    databaseURL: "https://website-83e14-default-rtdb.firebaseio.com",
    projectId: "website-83e14",
    storageBucket: "website-83e14.firebasestorage.app",
    messagingSenderId: "994953388464",
    appId: "1:994953388464:web:9c244de2a4fdcf8561f675",
    measurementId: "G-7PN256M5PG"
  };

  if (typeof firebase === 'undefined' || !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  // DOM elements
  const codeType = document.getElementById('codeType');
  const durationInput = document.getElementById('durationInput');
  const durationLabel = document.getElementById('durationLabel');
  const countInput = document.getElementById('countInput');
  const prefixInput = document.getElementById('prefixInput');
  const generateBtn = document.getElementById('generateBtn');
  const generatedList = document.getElementById('generatedList');
  const genStatus = document.getElementById('genStatus');

  const refreshBtn = document.getElementById('refreshBtn');
  const tableBody = document.querySelector('#codesTable tbody');
  const listStatus = document.getElementById('listStatus');
  const searchInput = document.getElementById('searchInput');

  const DIGITS = 6;

  codeType.addEventListener('change', () => {
    if (codeType.value === 'trial') {
      durationLabel.textContent = 'Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§ÙŠÙ‚ Ù„Ù„ØªØ¬Ø±Ø¨Ø©)';
      durationInput.value = 30;
    } else {
      durationLabel.textContent = 'Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù… Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ)';
      durationInput.value = 30;
    }
  });

  function generateNumericCode(prefix = '') {
    const num = Math.floor(Math.random() * 1000000);
    return prefix + String(num).padStart(DIGITS, '0');
  }

  async function isCodeExists(code) {
    const snap = await db.ref("approvedStudents/" + code).once("value");
    return snap.exists();
  }

  function showGenStatus(txt, cls='muted') {
    genStatus.style.display = 'block';
    genStatus.className = 'status ' + cls;
    genStatus.textContent = txt;
  }

  // ğŸš€ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ù‡Ùˆ Ø§Ù„Ø£Ù‡Ù…
  async function generateBatch() {
    const type = codeType.value;
    const duration = Number(durationInput.value) || 1;
    const count = Math.min(500, Math.max(1, Number(countInput.value) || 1));
    let prefix = (prefixInput.value || '').trim();
    if (prefix.length > 2) prefix = prefix.substring(0, 2);

    generatedList.value = '';
    showGenStatus("â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯...", "pending");
    generateBtn.disabled = true;

    const created = [];

    for (let i = 0; i < count; i++) {
      let code = '';
      let attempts = 0;

      while (attempts < 12) {
        code = generateNumericCode(prefix);
        if (!(await isCodeExists(code))) break;
        attempts++;
      }

      if (attempts >= 12) continue;

      const now = Date.now();

      // â›” ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨ expiry Ù‡Ù†Ø§
      // â›” Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙÙ‚Ø·
      const payload = {
        expiry: null,
        activationAt: null,
        isBlocked: false,
        deviceId: null,
        type: type,
        duration: duration,
        createdAt: now
      };

      await db.ref("approvedStudents/" + code).set(payload);
      created.push({code, ...payload});
      generatedList.value += code + "\n";
    }

    showGenStatus(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${created.length} ÙƒÙˆØ¯`, "success");
    generateBtn.disabled = false;
    generateBtn.dataset.last = JSON.stringify(created);
    refreshTable();
  }

  generateBtn.addEventListener("click", generateBatch);

  // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
  async function refreshTable() {
    tableBody.innerHTML = "";
    listStatus.style.display = "block";
    listStatus.className = "status pending";
    listStatus.textContent = "â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯...";

    const snap = await db.ref("approvedStudents").orderByKey().limitToLast(500).once("value");
    const data = snap.val() || {};
    const arr = Object.keys(data).reverse().map(k => ({code:k, ...data[k]}));

    const q = (searchInput.value || "").trim();
    const filtered = arr.filter(x =>
      !q || x.code.includes(q) || (x.deviceId || "").includes(q)
    );

    if (!filtered.length) {
      listStatus.className = 'status error';
      listStatus.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯';
      return;
    }

    listStatus.style.display = 'none';

    for (const it of filtered) {
      const expiryText = it.expiry ? new Date(it.expiry).toLocaleString('ar-EG') : "--";
      const state = it.isBlocked ? "Ù…Ø­Ø¸ÙˆØ±" : (it.expiry && it.expiry <= Date.now() ? "Ù…Ù†ØªÙ‡ÙŠ" : "Ø³Ø§Ø±ÙŠ");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${it.code}</b></td>
        <td>${it.type}</td>
        <td>${expiryText}</td>
        <td>${it.deviceId || '-'}</td>
        <td>${state}</td>
        <td>
          <button class="btn unblockBtn" data-code="${it.code}">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
          <button class="btn blockBtn" data-code="${it.code}">Ø­Ø¸Ø±</button>
          <button class="btn extendBtn" data-code="${it.code}">ØªÙ…Ø¯ÙŠØ¯</button>
          <button class="btn ghost deleteBtn" data-code="${it.code}">Ø­Ø°Ù</button>
        </td>
      `;
      tableBody.appendChild(tr);
    }

    document.querySelectorAll(".unblockBtn").forEach(b => b.addEventListener("click", resetDevice));
    document.querySelectorAll(".blockBtn").forEach(b => b.addEventListener("click", blockCode));
    document.querySelectorAll(".extendBtn").forEach(b => b.addEventListener("click", extendCode));
    document.querySelectorAll(".deleteBtn").forEach(b => b.addEventListener("click", deleteCode));
  }

  refreshBtn.addEventListener("click", refreshTable);
  searchInput.addEventListener("input", () => setTimeout(refreshTable, 300));

  async function resetDevice(e) {
    const code = e.target.dataset.code;
    await db.ref("approvedStudents/" + code + "/deviceId").remove();
    alert("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¬Ù‡Ø§Ø²");
    refreshTable();
  }

  async function blockCode(e) {
    const code = e.target.dataset.code;
    await db.ref("approvedStudents/" + code + "/isBlocked").set(true);
    alert("ØªÙ… Ø§Ù„Ø­Ø¸Ø±");
    refreshTable();
  }

  async function deleteCode(e) {
    const code = e.target.dataset.code;
    await db.ref("approvedStudents/" + code).remove();
    alert("ØªÙ… Ø§Ù„Ø­Ø°Ù");
    refreshTable();
  }

  refreshTable();
</script>

</body>
</html>
