<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Dashboard â€” Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (Ù†Ø¸Ø§Ù… Ø¬Ø¯ÙŠØ¯)</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f0f12;--card:#141418;--accent:#4e00ff;--danger:#ff3b3b;--ok:#00e1a6}
  *{box-sizing:border-box;font-family:'Cairo',sans-serif}
  body{margin:0;background:linear-gradient(180deg,#07070a,var(--bg));color:#fff;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .small{opacity:0.8;font-size:13px}
  .wrap{max-width:1100px;margin:18px auto}
  .card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:14px;border:1px solid rgba(255,255,255,0.03)}
  label{display:block;margin-top:8px;margin-bottom:6px;font-weight:600}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:rgba(255,255,255,0.02);color:#fff}
  button{background:var(--accent);border:none;color:#001;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .row-2{grid-template-columns:repeat(2,1fr)}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:center}
  th{background:rgba(255,255,255,0.02);font-weight:700}
  .btn-sm{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
  .btn-del{background:var(--danger);color:#fff}
  .btn-copy{background:#1f8bff;color:#fff}
  .btn-block{background:#ff8b00;color:#fff}
  .btn-unblock{background:#00b894;color:#fff}
  .hidden{display:none}
  .stats{display:flex;gap:10px}
  .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;text-align:center;min-width:120px}
  .right{display:flex;gap:8px;align-items:center}
  .small-note{font-size:12px;color:rgba(255,255,255,0.6)}
  @media(max-width:900px){.row{grid-template-columns:1fr}.stats{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap">

    <!-- ğŸ” Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† -->
    <div id="adminLoginCard" class="card" style="margin-bottom:16px;">
      <h3>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>

      <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
      <input id="adminEmail" type="email" placeholder="admin@example.com">

      <label>Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</label>
      <input id="adminPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">

      <button id="adminLoginBtn" style="margin-top:12px;background:#00e1a6;color:#000;font-weight:700">
        ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø£Ø¯Ù…Ù†
      </button>
    </div>

    <header>
      <div>
        <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)</h1>
        <div class="small">ØªÙˆÙ„ÙŠØ¯ØŒ Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø­Ø¸Ø± Ø£Ø¬Ù‡Ø²Ø©ØŒ Ø±ÙØ¹ Ø­Ø¸Ø±ØŒ ØªØµØ¯ÙŠØ±</div>
      </div>
      <div class="right">
        <div id="adminUidDisplay" class="small">Ø¬Ø§Ø±Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...</div>
        <button id="logoutBtn" class="hidden">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ© -->
    <div id="forbidden" class="card hidden" style="color:var(--danger);text-align:center;font-weight:700">
      âŒ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” uid Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ø£Ø¯Ù…Ù†
    </div>

    <!-- admin area -->
    <div id="adminArea" class="hidden">

      <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
      <div class="card">
        <div class="stats">
          <div class="stat"><div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</div><div id="statTotal">-</div></div>
          <div class="stat"><div class="small">Ø£ÙƒÙˆØ§Ø¯ Premium</div><div id="statPremium">-</div></div>
          <div class="stat"><div class="small">Ø£ÙƒÙˆØ§Ø¯ Trial</div><div id="statTrial">-</div></div>
          <div class="stat"><div class="small">Ø£Ø¬Ù‡Ø²Ø© Ù…Ø­Ø¸ÙˆØ±Ø©</div><div id="statBlocked">-</div></div>
        </div>
      </div>

      <!-- ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ -->
      <div class="card">
        <h3>âš¡ ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯</h3>
        <div class="row">
          <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</label><input id="autoCount" type="number" placeholder="Ù…Ø«Ø§Ù„: 20"></div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„ÙƒÙˆØ¯</label>
            <select id="codeType">
              <option value="trial">trial</option>
              <option value="premium">premium</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø¯Ø© (Ù‚ÙŠÙ…Ø©) â€” ØªÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… ÙˆØ­Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ù‡</label>
            <input id="autoDurationValue" type="number" placeholder="Ù…Ø«Ø§Ù„: 60">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¯Ø©</label>
            <select id="autoDurationUnit">
              <option value="minutes">Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="hours">Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª</option>
              <option value="days">Ø¨Ø§Ù„Ø§Ù„Ø£ÙŠØ§Ù…</option>
            </select>
            <div class="small-note">Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø³ÙŠÙƒÙˆÙ† Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (duration Ø¨Ø§Ù„Ù… Ø¯Ù‚Ø§Ø¦Ù‚)</div>
          </div>
          <div>
            <label>ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ù… ÙŠØ¯ÙˆÙŠØŸ</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="genBtn">âš¡ ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
              <button id="genSingleBtn" style="background:#00b894">â• ØªÙˆÙ„ÙŠØ¯ ÙˆØ§Ø­Ø¯</button>
            </div>
          </div>
          <div>
            <label>ØªØµØ¯ÙŠØ± / Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="exportBtn" style="background:#1f8bff">â¬‡ ØªØµØ¯ÙŠØ± CSV</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø£ÙƒÙˆØ§Ø¯ -->
      <div class="card">
        <h3>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h3>
        <div style="margin-bottom:8px">
          <label>Ø¨Ø­Ø« (ÙƒÙˆØ¯ Ø£Ùˆ Ø­Ø§Ù„Ø© Ø£Ùˆ Ù…Ø§Ù„Ùƒ)</label>
          <input id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
        </div>

        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ÙƒÙˆØ¯</th>
              <th>Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚)</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>isBlocked</th>
              <th>ownerUid</th>
              <th>Device (owner)</th>
              <th>Ø¥Ù†Ø´Ø§Ø¡</th>
              <th>Ù†Ø³Ø®</th>
              <th>Ø­Ø¸Ø±/ÙØªØ­ ÙƒÙˆØ¯</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="codesTable"></tbody>
        </table>
      </div>

      <!-- blocked devices -->
      <div class="card">
        <h3>ğŸš« Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</h3>
        <table>
          <thead><tr><th>Device ID</th><th>ØªÙ‚Ø±ÙŠØ± Ù…Ù†</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¸Ø±</th><th>Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±</th></tr></thead>
          <tbody id="blockedTable"></tbody>
        </table>
      </div>

      <!-- students -->
      <div class="card">
        <h3>ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙØ¹Ù‘Ù„ÙŠÙ†</h3>
        <div style="margin-bottom:8px">
          <label>Ø¨Ø­Ø« (UID Ø£Ùˆ Device)</label>
          <input id="studentsSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨...">
        </div>
        <table>
          <thead><tr><th>UID</th><th>DeviceId</th><th>Code</th><th>Ù†ÙˆØ¹</th><th>ØªÙØ¹ÙŠÙ„</th><th>Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø­Ø°Ù</th></tr></thead>
          <tbody id="studentsTable"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
  /******* CONFIG *******/
 const firebaseConfig = {
  apiKey: "AIzaSyAdz_OsGPL5xEq-J72FCkuQezVMhU_FATo",
  authDomain: "website-83e14.firebaseapp.com",
  databaseURL: "https://website-83e14-default-rtdb.firebaseio.com",
  projectId: "website-83e14",
  storageBucket: "website-83e14.firebasestorage.app",
  messagingSenderId: "994953388464",
  appId: "1:994953388464:web:9c244de2a4fdcf8561f675",
  measurementId: "G-7PN256M5PG"
};
// Ø¯Ø¹Ù… Ø£ÙƒØ«Ø± Ù…Ù† Ø£Ø¯Ù…Ù† Ù„Ùˆ Ø§Ø­ØªØ¬Øª
const ADMIN_UIDS = ["gI2tAMAFdZfpqj9TspSfWvgu6i33"];

if (!window.firebase) { console.error('Firebase SDK missing'); throw new Error('Firebase SDK missing'); }
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/******* Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© *******/
const adminArea = document.getElementById('adminArea');
const forbidden = document.getElementById('forbidden');
const adminUidDisplay = document.getElementById('adminUidDisplay');
const logoutBtn = document.getElementById('logoutBtn');
const adminLoginCard = document.getElementById("adminLoginCard");

const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminEmailInput = document.getElementById('adminEmail');
const adminPassInput = document.getElementById('adminPass');

const statTotal = document.getElementById('statTotal');
const statPremium = document.getElementById('statPremium');
const statTrial = document.getElementById('statTrial');
const statBlocked = document.getElementById('statBlocked');

const genBtn = document.getElementById('genBtn');
const genSingleBtn = document.getElementById('genSingleBtn');
const exportBtn = document.getElementById('exportBtn');
const codesTable = document.getElementById('codesTable');
const blockedTable = document.getElementById('blockedTable');
const searchInput = document.getElementById('searchInput');

const autoCount = document.getElementById('autoCount');
const codeType = document.getElementById('codeType');
const autoDurationValue = document.getElementById('autoDurationValue');
const autoDurationUnit = document.getElementById('autoDurationUnit');

const studentsTable = document.getElementById('studentsTable');
const studentsSearch = document.getElementById('studentsSearch');

/******* Helpers *******/
function isAdminUID(uid){
  return ADMIN_UIDS.includes(uid);
}
function msFrom(value, unit){
  // convert value+unit to minutes (we store duration in minutes)
  const v = Number(value) || 0;
  if(unit==='minutes') return v;
  if(unit==='hours') return v*60;
  if(unit==='days') return v*60*24;
  return v;
}
function generateCode() {
  const digits = "0123456789";
  let code = "";
  for (let i = 0; i < 6; i++) code += digits[Math.floor(Math.random() * digits.length)];
  return code;
}

/******* Auth (admin) *******/
adminLoginBtn.addEventListener('click', async () => {
  const email = adminEmailInput.value.trim();
  const pass = adminPassInput.value.trim();
  if(!email||!pass) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯');
  try{
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const uid = cred.user.uid;
    if(!isAdminUID(uid)){
      alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© â€” UID ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø£Ø¯Ù…Ù†');
      await auth.signOut();
      return;
    }
    alert('âœ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ù†Ø§Ø¬Ø­');
    adminLoginCard.classList.add('hidden');
  }catch(e){
    alert('âŒ Ø®Ø·Ø£: ' + (e.message||e));
  }
});

auth.onAuthStateChanged(user=>{
  if(!user){
    adminUidDisplay.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    forbidden.classList.add('hidden');
    adminArea.classList.add('hidden');
    adminLoginCard.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    return;
  }
  adminUidDisplay.textContent = 'uid: ' + user.uid;
  logoutBtn.classList.remove('hidden');
  logoutBtn.onclick = ()=> auth.signOut().then(()=> location.reload());
  if(isAdminUID(user.uid)){
    adminArea.classList.remove('hidden');
    forbidden.classList.add('hidden');
    adminLoginCard.classList.add('hidden');
    // load data
    loadStudentsRealtime();
    loadCodesRealtime();
    loadBlockedRealtime();
  } else {
    adminArea.classList.add('hidden');
    forbidden.classList.remove('hidden');
    adminLoginCard.classList.remove('hidden');
  }
});

/******* Realtime loaders *******/
let latestCodes = {};
let studentsMap = {}; // uid -> student object
let blockedMap = {};  // deviceId/fp -> obj

function loadStudentsRealtime(){
  const ref = db.ref('approvedStudents');
  ref.on('value', snap=>{
    const data = snap.val() || {};
    studentsMap = data;
    renderStudentsTable(data);
    // also update device info in codes table after codes loaded
    renderCodesTable(latestCodes);
  });
}

function loadCodesRealtime(){
  const ref = db.ref('approvedCodes');
  ref.on('value', snap=>{
    const data = snap.val() || {};
    latestCodes = data;
    renderCodesTable(data);
    updateStats();
  });
}

function loadBlockedRealtime(){
  const ref = db.ref('blockedDevices');
  ref.on('value', snap=>{
    const data = snap.val() || {};
    blockedMap = data;
    renderBlockedTable(data);
    statBlocked.textContent = Object.keys(data || {}).length;
  });
}

/******* Renderers *******/
function renderCodesTable(data){
  const q = (searchInput.value||'').trim().toLowerCase();
  codesTable.innerHTML = '';
  const rows = Object.keys(data).sort();
  rows.forEach(code=>{
    const d = data[code] || {};
    const duration = Number(d.duration) || 0; // minutes
    const type = d.type || '';
    const isBlocked = !!d.isBlocked;
    const ownerUid = d.ownerUid || '';
    const createdAt = d.createdAt ? new Date(d.createdAt).toLocaleString() : '-';
    // find device of owner
    const ownerDevice = ownerUid && studentsMap[ownerUid] ? (studentsMap[ownerUid].deviceId || '-') : '-';

    if(q && !code.includes(q) && !type.includes(q) && !ownerUid.toLowerCase().includes(q) && !(ownerDevice+'').toLowerCase().includes(q)) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${code}</td>
      <td>${duration}</td>
      <td>${type}</td>
      <td>${isBlocked ? 'Ù…Ù‚ÙÙˆÙ„' : 'Ù…ÙØªÙˆØ­'}</td>
      <td>${ownerUid || '-'}</td>
      <td>${ownerDevice}</td>
      <td>${createdAt}</td>
      <td><button class="btn-sm btn-copy" data-code="${code}">Ù†Ø³Ø®</button></td>
      <td>
        <button class="btn-sm ${isBlocked ? 'btn-unblock' : 'btn-block'}" data-code="${code}">
          ${isBlocked ? 'ÙØªØ­' : 'Ø­Ø¸Ø±'}
        </button>
      </td>
      <td><button class="btn-sm btn-del" data-code="${code}">Ø­Ø°Ù</button></td>
    `;
    codesTable.appendChild(tr);
  });

  // actions
  document.querySelectorAll('.btn-copy').forEach(btn=>{
    btn.onclick = e => {
      const c = e.currentTarget.dataset.code;
      navigator.clipboard.writeText(c);
      alert('ØªÙ… Ù†Ø³Ø®: ' + c);
    };
  });

  document.querySelectorAll('.btn-del').forEach(btn=>{
    btn.onclick = e => {
      const c = e.currentTarget.dataset.code;
      if(!confirm('Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ '+c+' ØŸ')) return;
      // remove code from approvedCodes
      db.ref('approvedCodes/'+c).remove().then(()=> alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯'));
    };
  });

  document.querySelectorAll('.btn-block').forEach(btn=>{
    btn.onclick = async e => {
      const c = e.currentTarget.dataset.code;
      if(!confirm('Ø­Ø¸Ø± Ø§Ù„ÙƒÙˆØ¯ '+c+' ØŸ (Ø³ÙŠÙ…Ù†Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡)')) return;
      await db.ref('approvedCodes/'+c+'/isBlocked').set(true);
      alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„ÙƒÙˆØ¯');
    };
  });

  document.querySelectorAll('.btn-unblock').forEach(btn=>{
    btn.onclick = async e => {
      const c = e.currentTarget.dataset.code;
      if(!confirm('ÙØªØ­ Ø§Ù„ÙƒÙˆØ¯ '+c+' ØŸ')) return;
      await db.ref('approvedCodes/'+c+'/isBlocked').set(false);
      alert('ØªÙ… ÙØªØ­ Ø§Ù„ÙƒÙˆØ¯');
    };
  });
}

function renderBlockedTable(data){
  blockedTable.innerHTML = '';
  const keys = Object.keys(data || {});
  if(!keys.length){
    blockedTable.innerHTML = '<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¸Ø±</td></tr>';
    return;
  }
  keys.forEach(id=>{
    const d = data[id] || {};
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${id}</td>
      <td>${d.reporterUid || '-'}</td>
      <td>${d.blockedAt ? new Date(d.blockedAt).toLocaleString() : '-'}</td>
      <td><button class="btn-sm btn-unblock" data-id="${id}">Ø±ÙØ¹</button></td>
    `;
    blockedTable.appendChild(tr);
  });

  document.querySelectorAll('.btn-unblock').forEach(btn=>{
    btn.onclick = e => {
      const id = e.currentTarget.dataset.id;
      if(confirm('Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±ØŸ')) db.ref('blockedDevices/'+id).remove();
    };
  });
}

function renderStudentsTable(data){
  studentsTable.innerHTML = '';
  const q = (studentsSearch.value||'').trim().toLowerCase();
  const keys = Object.keys(data || {});
  if(!keys.length){
    studentsTable.innerHTML = '<tr><td colspan="7">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…ÙØ¹Ù„ÙŠÙ†</td></tr>';
    return;
  }
  keys.forEach(uid=>{
    const d = data[uid] || {};
    if(q && !uid.includes(q) && !(d.deviceId||'').toLowerCase().includes(q) && !(d.code||'').includes(q)) return;
    const activated = d.activationAt ? new Date(d.activationAt).toLocaleString() : '-';
    const expiry = d.expiry ? new Date(d.expiry).toLocaleString() : '-';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${uid}</td>
      <td>${d.deviceId || '-'}</td>
      <td>${d.code || '-'}</td>
      <td>${d.type || '-'}</td>
      <td>${activated}</td>
      <td>${expiry}</td>
      <td><button class="btn-sm btn-del" data-uid="${uid}">Ø­Ø°Ù</button></td>
    `;
    studentsTable.appendChild(tr);
  });

  document.querySelectorAll('#studentsTable .btn-del').forEach(btn=>{
    btn.onclick = e => {
      const uid = e.currentTarget.dataset.uid;
      if(!confirm('Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ '+uid+' ØŸ')) return;
      db.ref('approvedStudents/'+uid).remove().then(()=> alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨'));
    };
  });
}

/******* Stats *******/
function updateStats(){
  const codes = latestCodes || {};
  let total = 0, premium = 0, trial = 0;
  Object.keys(codes).forEach(k=>{
    total++;
    if((codes[k].type||'') === 'premium') premium++;
    else if((codes[k].type||'') === 'trial') trial++;
  });
  statTotal.textContent = total;
  statPremium.textContent = premium;
  statTrial.textContent = trial;
}

/******* Generation *******/
// Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø²Ø±Ø§Ø±
genSingleBtn.addEventListener('click', generateSingleCode);
genBtn.addEventListener('click', generateAutoCodes);
exportBtn.addEventListener('click', exportCodesCSV);

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¶ÙŠÙØªÙ‡Ù… ÙÙŠ HTML)
const codesModal = document.getElementById('codesModal');
const modalCodesList = document.getElementById('modalCodesList');
const closeModalBtn = document.getElementById('closeModalBtn');
const copyModalCodesBtn = document.getElementById('copyModalCodesBtn');

closeModalBtn.onclick = () => codesModal.classList.add('hidden');
copyModalCodesBtn.onclick = () => {
  navigator.clipboard.writeText(modalCodesList.value);
  alert('âœ” ØªÙ… Ù†Ø³Ø® ÙƒÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯');
};

// ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ÙˆØ§Ø­Ø¯
async function generateSingleCode(){
  if(!auth.currentUser || !isAdminUID(auth.currentUser.uid)) return alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­');
  const type = codeType.value;
  const val = Number(autoDurationValue.value) || 0;
  const unit = autoDurationUnit.value;
  if(!val) return alert('Ø§ÙƒØªØ¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø©');
  const durationMinutes = msFrom(val, unit);
  const code = generateCode();
  const payload = {
    duration: durationMinutes,
    type,
    isBlocked: false,
    ownerUid: '',
    createdAt: Date.now()
  };
  await db.ref('approvedCodes/'+code).set(payload);
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  modalCodesList.value = code;
  codesModal.classList.remove('hidden');
}

// ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ù…ØªØ¹Ø¯Ø¯Ø©
async function generateAutoCodes(){
  if(!auth.currentUser || !isAdminUID(auth.currentUser.uid)) return alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­');
  const count = parseInt(autoCount.value) || 0;
  const type = codeType.value;
  const val = Number(autoDurationValue.value) || 0;
  const unit = autoDurationUnit.value;
  if(!count) return alert('Ø§ÙƒØªØ¨ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­');
  if(!val) return alert('Ø§ÙƒØªØ¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø©');
  const durationMinutes = msFrom(val, unit);
  const updates = {};
  const codesArr = [];
  for(let i=0;i<count;i++){
    const code = generateCode();
    codesArr.push(code);
    updates['approvedCodes/'+code] = {
      duration: durationMinutes,
      type,
      isBlocked: false,
      ownerUid: '',
      createdAt: Date.now()
    };
  }
  await db.ref().update(updates);
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  modalCodesList.value = codesArr.join('\n');
  codesModal.classList.remove('hidden');
}

/******* Export CSV *******/
function exportCodesCSV(){
  const codes = latestCodes || {};
  const rows = [['code','duration_minutes','type','isBlocked','ownerUid','createdAt']];
  Object.keys(codes).forEach(c=>{
    const d = codes[c] || {};
    rows.push([c, String(d.duration||''), d.type||'', String(!!d.isBlocked), d.ownerUid||'', d.createdAt||'']);
  });
  const csv = rows.map(r=> r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'approvedCodes.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/******* Block device helper (by deviceId) *******/
async function blockDevice(deviceId, reporterUid){
  if(!deviceId) return alert('Device ID ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  await db.ref('blockedDevices/'+deviceId).set({
    reporterUid: reporterUid || (auth.currentUser ? auth.currentUser.uid : 'admin'),
    blockedAt: Date.now(),
    reason: 'admin'
  });
  alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²: ' + deviceId);
}

/******* Utility: allow blocking device from codes table by ownerDevice cell click *******/
codesTable.addEventListener('click', (e)=>{
  const btn = e.target;
  if(btn.tagName !== 'BUTTON') return;
  // already handled above for specific buttons
});

/******* Search handlers *******/
searchInput.addEventListener('input', ()=> renderCodesTable(latestCodes));
studentsSearch.addEventListener('input', ()=> renderStudentsTable(studentsMap));

/******* Init: small guard to ensure structure exists *******/
(async function initEnsure(){
  // ensure the root paths exist (no-op if already)
  try{
    await db.ref().update({ _meta_exists: true });
    // then remove the helper key
    await db.ref('_meta_exists').remove();
  }catch(e){ /* ignore */ }
})();

  </script>
</body>
</html>
